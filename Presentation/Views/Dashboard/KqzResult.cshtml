@model PoliticalOfficalVM;
@{
    Layout = "_DashboardLayout";
}

<section class="section">
    <div class="row">
        <div class="card p-5">
            <h2 class="card-title ps-4">Përshkruar numrin e votuesëve dhe rezultateve nga KQZ</h2>
            <div class="d-flex flex-md-row flex-column">
                <div class="col-md-6">
                    <div class="card-body pt-2">
                        <form asp-action="KqzResult" asp-controller="Dashboard" method="post">
                            <div class="col-12 ">
                                <label>Qyteti</label>
                                <select class="form-select slist" id="munis" asp-for="Municipality" id="munis">
                                    <option disabled selected>Zgjedh qytetin..</option>


                                </select>
                                <span asp-validation-for="Municipality" class="text-danger"></span>

                            </div>
                            <div class="col-12">
                                <label class="pt-4">Fshati</label>
                                <select class="form-select slist" id="villages" asp-for="Village" id="villages">
                                    <option disabled selected>Zgjedh fshatin..</option>
                                </select>
                                <span asp-validation-for="Village" class="text-danger"></span>

                            </div>
                            <div id="neigborhoods-container" class="col-12 pt-4">
                                <label>Lagja</label>
                                <select class="form-select slist" asp-for="Neigborhood" id="neigborhoods">
                                    <option disabled selected>Zgjedh lagjen..</option>
                                </select>
                                <span asp-validation-for="Neigborhood" class="text-danger"></span>
                            </div>
                            <div id="neigborhoodsVillage-container" class="col-12 pt-4">
                                <label>Lagja</label>
                                <select class="form-select slist"  asp-for="Neigborhood" id="neigborhoodsVillage">
                                    <option disabled selected>Zgjedh lagjen..</option>

                                </select>
                                <span asp-validation-for="Neigborhood" class="text-danger"></span>

                            </div>
                            <div class="col-12">
                                <label class="pt-4">Lloji i zgjedhjeve</label>
                                <select class="form-select slist" id="zgjedhjet">
                                    <option disabled selected>Zgjedh llojin e zgjedhjeve..</option>
                                    <option>Zgjedhjet Nacionale</option>
                                    <option>Zgjedhjet Lokale</option>
                                </select>


                            </div>
                            <div class="col-12">
                                <label class="pt-4">Viti i zgjedhjeve</label>
                                <input type="date" id="year" class="form-control">
                                <span class="text-danger"></span>
                            </div>
                            <div id="pollcenter-villages-container" class="col-12 pt-4 pb-4">
                                <label>Qendra e vendvotimit</label>
                                <select class="form-select slist" asp-for="PollCenter" id="poll">
                                    <option disabled selected>Zgjedh qendren e zgjedhjeve..</option>
                                </select>
                                <span asp-validation-for="PollCenter" class="text-danger"></span>

                            </div>
                            <div id="pollcenter-neighborhood-container" class="col-12 pt-4 pb-4">
                                <label>Qendra e vendvotimit</label>
                                <select class="form-select slist" asp-for="PollCenter" id="pollNeighborhood">
                                    <option disabled selected>Zgjedh qendren e zgjedhjeve..</option>
                                </select>
                            </div>

                            <button id="slistbtn" type="submit" id="main-div" class="btn btn-primary">Regjistro votimet</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6 pt-5 ps-4">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col">Numri i votuesëve</th>
                                    <th scope="col">Total:<span id="span" class="float-end"></span></th>@*Me bo nje formule per me i mbledh te gjitha votat e partive politike*@
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th scope="row" class="parti" value="1">VV</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                                <tr>
                                    <th scope="row" class="parti" value="2">LDK</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                                <tr>
                                    <th scope="row" class="parti" value="3">PDK</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                                <tr>
                                    <th scope="row" class="parti" value="4">AAK</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                                <tr>
                                    <th scope="row" class="parti" value="5">AKR</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                                <tr>
                                    <th scope="row" class="parti" value="6">Nisma</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                                <tr>
                                    <th scope="row" class="parti" value="7">Partite serbe</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                                <tr>
                                    <th scope="row" class="parti" value="8">Partite joserbe</th>
                                    <td><input type="number" class="border-0 votat" /></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts
{


@*<script>
    //Disabled Button 
        $('#pollNeighborhood').on('change', function () {
        $('#slistbtn').prop('disabled', !$(this).val());
    }).trigger('change');
</script>*@
<script>


    $('#neigborhoodsVillage-container').hide();

    $('#villages').change(function(){
        var selectedVillage = $(this).children('option:selected').val();
        if(selectedVillage != null){
            $('#neigborhoods-container').hide();
            $('#neigborhoodsVillage-container').show();
        }
    })
    $('#munis').change(function(){
        var selectedMunis = $(this).children('option:selected').val();
        if(selectedMunis != null){
            $('#neigborhoods-container').show();
            $('#neigborhoodsVillage-container').hide();
        }
    });


     $('#pollcenter-villages-container').hide();

    $('#neigborhoods').change(function(){
        var selectedVillage = $(this).children('option:selected').val();
        if(selectedVillage != null){
            $('#pollcenter-villages-container').hide();
            $('#pollcenter-neighborhood-container').show();
        }
    })
    $('#villages').change(function(){
        var selectedNeighborhood = $(this).children('option:selected').val();
        if(selectedNeighborhood != null){
            $('#pollcenter-villages-container').show();
            $('#pollcenter-neighborhood-container').hide();
        }
    });
</script>

<script>
    const munis = document.querySelector('#munis');
    const villages = document.querySelector('#villages');
    const url = "https://localhost:7278/api/service/";
    const button = document.querySelector('#main-div');

    const votat = document.getElementsByClassName("votat");
    const year = document.getElementById('year');
    const poll = document.getElementById('poll');
    const span = document.getElementById('span');
    var shuma = 0;
    var input;
    var vlera;
    for(let i=0; i<votat.length; i++){

            votat[i].addEventListener('focus', e => {
                e.preventDefault();
                vlera = 0;
                if(votat[i].value !== '' ){
                    vlera = parseInt(votat[i].value);
                }
            });
            votat[i].addEventListener('blur', e => {
                e.preventDefault();
                input = parseInt(votat[i].value);
                //console.log("Inputi"+input);

                if(!isNaN(input)){
                    if (vlera!==0){
                        shuma = shuma - vlera;
                    }
                    shuma += input;
                    span.innerHTML = shuma;

                }
                else if (isNaN(input)) {
                    shuma = shuma - vlera;
                    span.innerHTML = shuma;

                }
             });
    }

    getMunis();

    function addDataToDb() {
        let endpoint = url + "addkqzresult";

        const election = document.getElementById("inputGroupSelect03").value;
        const year = document.getElementById('year');
        const poll = document.getElementById('poll');
        const neighborhood = document.getElementById('neigborhoods').value
        const parti = document.getElementsByClassName("parti");
        const votat = document.getElementsByClassName("votat");


        for (var i=1; i <= votat.length; i++) {
            fetch(endpoint, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: 'post',
                body: JSON.stringify({

                    municipalityId: munis.value, villageId: villages.value, neighborhoodId: neighborhood,

                    electionType: election, dataCreated: year.value, pollCenterId: poll.value, politicialSubjectId: i, noOfvotes: votat[i-1].value
                })
            });
        }
    }

        munis.addEventListener('change', event => {
            addVillagesToList(event.target.value);
            addNeigborhoodToList(event.target.value);

        });

        villages.addEventListener('change', event=>{
            addNeigborhoodVillageToList(event.target.value);
            addPollCenterToList(event.target.value);
        });
        neigborhoods.addEventListener('change', event =>{
            addPollCenterNeighborhoodToList(event.target.value);
        });

        villages.addEventListener('change', event => {
            event.preventDefault();
            if (event.target.value == 'shto') {
                addVillageToDb();
                addQendraVotimitToList(event.target.value);
            }
            else {
                addQendraVotimitToList(event.target.value);
            }
        });
        neigborhoods.addEventListener('change', event => {
            event.preventDefault();
            if (event.target.value == 'shto') {
                addNeigborhoodToDb();
            }
        });
        neigborhoodsVillage.addEventListener('change', event => {
            event.preventDefault();
            if (event.target.value == 'shto') {
                addNeigborhoodVillageToDb();
            }
        });
        poll.addEventListener('change', event => {
            event.preventDefault();
            if (event.target.value == 'shto'){
                addPollCenterToDb();
            }
        });
        pollNeighborhood.addEventListener('change', event => {
            event.preventDefault();
            if(event.target.value == "shto"){
                addPollCenterNeighborhoodToDb();
            }
        });

        function getMunis(id){
            let endpoint = url + "getmunis";
            let result = fetch(endpoint)
            .then(res => res.json())
            .then(data => {
                data.forEach(x => {
                    let item = document.createElement("option");
                    item.value = x.id;
                    item.innerText = x.name;
                    munis.appendChild(item);
                });
            });
        }
    function getVillage(id){
        let endpoint = url + "getvillage";
        let result = fetch(endpoint)
        .then(res => res.json())
        .then(data => {
            data.forEach(x => {
                let item = document.createElement("option");
                item.value = x.id;
                item.innerText = x.name;
                villages.appendChild(item);
            });
        });
    }

    function addVillagesToList(muniId){
        villages.innerHTML = '';
        let chooseOption = document.createElement("option");
        chooseOption.innerText = "Zgjedh fshatin...";
        chooseOption.selected = true;
        chooseOption.disabled = true;
        villages.appendChild(chooseOption);

        let addOption = document.createElement("option");
        addOption.innerText = "Shto fshat te ri...";
        addOption.value = "shto";
        villages.appendChild(addOption);

        let endpoint = url + "getvillagesbymuni?muniid=" + muniId;
        let result = fetch(endpoint)
        .then(res => res.json())
        .then(data => data.forEach(x => {
            let item = document.createElement("option");
            item.value = x.id;
            item.innerText = x.name;
            villages.appendChild(item);
        }));
    }

    function addVillageToDb(){
        let endpoint = url + "addvillage";
        let input = prompt("Shto fshatin e ri:");
        //let selectedMuni = $('#munis').val();
        let sm = document.querySelector("#munis").value;
        fetch(endpoint, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: 'post',
            body: JSON.stringify({municipalityId: sm, villageName: input})
        }).then(() => addVillagesToList(sm));

    }
    //neigborhoods
    function addNeigborhoodToList(muniId){
        neigborhoods.innerHTML = '';
        let chooseOption = document.createElement("option");
        chooseOption.innerText = "Zgjedh lagjen...";
        chooseOption.selected = true;
        chooseOption.disabled = true;
        neigborhoods.appendChild(chooseOption);

        let addOption = document.createElement("option");
        addOption.innerText = "Shto lagjen e re...";
        addOption.value = "shto";
        neigborhoods.appendChild(addOption);

        let endpoint = url + "getneighborhoodsbymuni?muniid=" + muniId;
        let result = fetch(endpoint)
        .then(res => res.json())
        .then(data => data.forEach(x => {
            let item = document.createElement("option");
            item.value = x.id;
            item.innerText = x.name;
            neigborhoods.appendChild(item);
        }));
    }
    function addNeigborhoodToDb(){
        let endpoint = url + "addneighborhood";
        let input = prompt("Shto lagjen e re:");
        let sm = document.querySelector("#munis").value;
        fetch(endpoint, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: 'post',
            body: JSON.stringify({municipalityId: sm, neighborhoodName: input})
        }).then(() => addNeigborhoodToList(sm));
    }
    //neigborhood by village
    function addNeigborhoodVillageToList(villId){
        neigborhoodsVillage.innerHTML = '';
        let chooseOption = document.createElement("option");
        chooseOption.innerText = "Zgjedh lagjen...";
        chooseOption.selected = true;
        chooseOption.disabled = true;
        neigborhoodsVillage.appendChild(chooseOption);

        let addOption = document.createElement("option");
        addOption.innerText = "Shto lagjen e re...";
        addOption.value = "shto";
        neigborhoodsVillage.appendChild(addOption);

        let endpoint = url + "getneighborhoodsbyvillage?villId=" + villId;
        let result = fetch(endpoint)
        .then(res => res.json())
        .then(data => data.forEach(x => {
            let item = document.createElement("option");
            item.value = x.id;
            item.innerText = x.name;
            neigborhoodsVillage.appendChild(item);
        }));
    }

    function addNeigborhoodVillageToDb(){
        let endpoint = url + "addneighborhoodbyvillage";
        let input = prompt("Shto lagjen e re:");
        let sm = document.querySelector("#villages").value;
        fetch(endpoint, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: 'post',
            body: JSON.stringify({villageId: sm, neighborhoodName: input})
        }).then(() => addNeigborhoodVillageToList(sm));
    }
    //poll center by village
    function addPollCenterToList(villId){
        poll.innerHTML = '';
        let chooseOption = document.createElement("option");
        chooseOption.innerText = "Zgjedh qendren e votimit...";
        chooseOption.selected = true;
        chooseOption.disabled = true;
        poll.appendChild(chooseOption);

        let addOption = document.createElement("option");
        addOption.innerText = "Shto qendren e re të votimit...";
        addOption.value = "shto";
        poll.appendChild(addOption);

        let endpoint = url + "getpollcenterbyvillage?villId=" + villId;
        let result = fetch(endpoint)
        .then(res => res.json())
        .then(data => data.forEach(x => {
            let item = document.createElement("option");
            item.value = x.id;
            item.innerText = x.name;
            poll.appendChild(item);
        }));
    }
    function addPollCenterToDb(){
        let endpoint = url + "addpollcenterbyvillage";
        let input = prompt("Shto qendren e re të votimit:");
        let sm = document.querySelector("#villages").value;
        fetch(endpoint, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: 'post',
            body: JSON.stringify({villageId: sm, centerNumber: input})
        }).then(() => addPollCenterToList(sm));
    }
    //poll center by neighborhood
    function addPollCenterNeighborhoodToList(neighId){
        pollNeighborhood.innerHTML = '';
        let chooseOption = document.createElement("option");
        chooseOption.innerText = "Zgjedh qendren e votimit...";
        chooseOption.selected = true;
        chooseOption.disabled = true;
        pollNeighborhood.appendChild(chooseOption);

        let addOption = document.createElement("option");
        addOption.innerText = "Shto qendren e re të votimit...";
        addOption.value = "shto";
        pollNeighborhood.appendChild(addOption);

        let endpoint = url + "getpollcenterbyneigborhood?neighId=" + neighId;
        let result = fetch(endpoint)
        .then(res => res.json())
        .then(data => data.forEach(x => {
            let item = document.createElement("option");
            item.value = x.id;
            item.innerText = x.name;
            pollNeighborhood.appendChild(item);
        }));
    }
    function addPollCenterNeighborhoodToDb(){
        let endpoint = url + "addpollcenterbyneighborhood";
        let input = prompt("Shto qendren e re të votimit...");
        let sm = document.querySelector("#neigborhoods").value;
        fetch(endpoint, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: 'post',
            body: JSON.stringify({neighborhoodId: sm, centerNumber: input})
        }).then(() => addPollCenterNeighborhoodToList(sm));
    }

</script>
}

